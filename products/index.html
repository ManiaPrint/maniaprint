<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Products ‚Äî Mania Print</title>
  <meta name="description" content="All products and standard offerings ‚Äî Mania Print"/>
  <link rel="icon" type="image/png" href="../images/logo.png" />
  <link rel="stylesheet" href="../styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-container">
      <div class="logo-container">
        <img src="../images/logo-transparent.png" alt="Mania Print Logo" class="logo-img" onerror="this.style.display='none'">
        <a class="logo" href="..">Mania Print</a>
      </div>
      <nav class="nav" id="nav">
        <a href="../#services">Services</a>
        <a href="../#gallery">Gallery</a>
        <a href="../#pricing">Pricing</a>
        <a href="../#contact">Contact</a>
        <a href="#" class="nav-active">Products</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="tools-hero">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:20px; flex-wrap:wrap;">
        <div>
          <h1>Products</h1>
          <p class="small">Standard PLA prints, bundles and starter kits you can order straight away. Filter by type, search by name or details.</p>
        </div>
        <a class="btn back" href="../">Back to Home</a>
      </div>

      <div class="controls">
        <div class="search" role="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/>
          </svg>
          <input id="q" placeholder="Search products by name, size or color" />
        </div>

        <select id="sort" class="hidden">
          <option value="alpha">Name (A ‚Üí Z)</option>
          <option value="alpha-desc">Name (Z ‚Üí A)</option>
          <option value="price-asc">Price (low ‚Üí high)</option>
          <option value="price-desc">Price (high ‚Üí low)</option>
        </select>

        <div id="sort-dropdown" class="custom-select">
          <button class="custom-select-button">Name (A ‚Üí Z) ‚ñæ</button>
          <div class="custom-select-options hidden">
            <div class="custom-select-option" data-value="alpha">Name (A ‚Üí Z)</div>
            <div class="custom-select-option" data-value="alpha-desc">Name (Z ‚Üí A)</div>
            <div class="custom-select-option" data-value="price-asc">Price (low ‚Üí high)</div>
            <div class="custom-select-option" data-value="price-desc">Price (high ‚Üí low)</div>
          </div>
        </div>
      </div>

      <div class="chips" id="chips"></div>
    </section>

    <div id="grid" class="cards-grid" aria-live="polite"></div>
    <div id="empty" class="small" style="margin-top:40px;text-align:center;color:var(--muted);display:none;">No products match your search.</div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <small>¬© Mania Print ‚Äî made with filament & cookies üç™</small>
    </div>
  </footer>

  <script>
  (function(){
    const grid = document.getElementById('grid');
    const chips = document.getElementById('chips');
    const q = document.getElementById('q');
    const sort = document.getElementById('sort');
    const empty = document.getElementById('empty');
    const sortBtn = document.querySelector('.custom-select-button');
    const sortOpts = document.querySelector('.custom-select-options');

    let products = [];
    let activeType = null;
    let viewer3D = null;

    async function fetchProducts(){
      const r = await fetch('products.json', {cache:'no-store'});
      if (!r.ok) throw new Error('products.json not found');
      return await r.json();
    }

    function escapeHtml(s){ 
      if(!s && s !== 0) return ''; 
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); 
    }

    function makeIcon(title, type){
      const initial = title && title[0] ? title[0].toUpperCase() : '?';
      const colors = {
        'Standard': 'background: linear-gradient(135deg, rgba(79,195,247,0.2), rgba(33,150,243,0.1));',
        'Premium': 'background: linear-gradient(135deg, rgba(100,181,246,0.25), rgba(79,195,247,0.15));',
        'Bundle': 'background: linear-gradient(135deg, rgba(79,195,247,0.3), rgba(33,150,243,0.2));',
        'Custom': 'background: linear-gradient(135deg, rgba(100,181,246,0.2), rgba(79,195,247,0.1));'
      };
      const color = colors[type] || 'background: linear-gradient(135deg, rgba(79,195,247,0.15), rgba(33,150,243,0.08));';
      return `<div class="icon" style="${color}">${initial}</div>`;
    }

    function renderCard(item) {
      const priceDisplay = (typeof item.price === 'number') ? `$${item.price.toFixed(2)}` : (item.price || 'Quote');
      const tagsHtml = (item.tags || []).map(t => `<span class="chip">${escapeHtml(t)}</span>`).join(' ');
      
      let iconHtml = '';
      if(item.image) {
        iconHtml = `<div class="icon"><img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.title)}" style="width:100%; height:100%; object-fit:cover;"></div>`;
      } else {
        iconHtml = makeIcon(item.title, item.type);
      }

      const has3D = item['3Dfile'] && item['3Dfile'].trim() !== '';
      const viewBtn = has3D 
        ? `<button class="btn small ghost view-3d" data-id="${escapeHtml(item.id || '')}" data-file="${escapeHtml(item['3Dfile'])}">View in 3D</button>`
        : `<button class="btn small ghost" disabled style="opacity:0.5;">No 3D Model</button>`;

      return `<article class="tool-card" data-title="${escapeHtml(item.title)}" data-desc="${escapeHtml(item.description || '')}" data-type="${escapeHtml(item.type || '')}" data-tags="${escapeHtml((item.tags || []).join(','))}">
        <div class="card-top">
          ${iconHtml}
          <div style="min-width:0;flex:1;display:flex;flex-direction:column;">
            <h3>${escapeHtml(item.title)}</h3>
            <p class="card-desc">${escapeHtml(item.description || '')}</p>
            <div class="card-tags">${tagsHtml}</div>
          </div>
        </div>
        <div class="card-actions">
          <a class="btn small primary" href="../#contact">Order</a>
          ${viewBtn}
          <div class="price">${priceDisplay}</div>
        </div>
      </article>`;
    }

    function renderList(list){
      if (!list || list.length === 0) {
        grid.innerHTML = ''; 
        empty.style.display = 'block'; 
        return;
      }
      empty.style.display = 'none';
      grid.innerHTML = list.map(renderCard).join('');
      attach3DHandlers();
    }

    function gatherTypes(list){
      const s = new Set();
      list.forEach(it => {
        if(it.type) s.add(it.type);
      });
      return Array.from(s).sort();
    }

    function buildChips(allTypes){
      chips.innerHTML = '';

      const btnAll = document.createElement('button');
      btnAll.className = 'chip' + (activeType === null ? ' active' : '');
      btnAll.textContent = 'All';
      btnAll.addEventListener('click', ()=>{ 
        activeType = null; 
        applyFilters(); 
        updateChips(); 
      });
      chips.appendChild(btnAll);

      allTypes.forEach(type=>{
        const b = document.createElement('button');
        b.className = 'chip' + (activeType === type ? ' active' : '');
        b.textContent = type;
        b.addEventListener('click', ()=> {
          activeType = (activeType === type) ? null : type;
          applyFilters();
          updateChips();
        });
        chips.appendChild(b);
      });
    }

    function updateChips(){
      document.querySelectorAll('.chip').forEach(el => {
        el.classList.remove('active');
        if (
          (activeType === null && el.textContent === 'All') || 
          (activeType !== null && el.textContent === activeType)
        ) {
          el.classList.add('active');
        }
      });
    }

    function getPriceValue(item) {
      if (typeof item.price === 'number') return item.price;
      return Infinity;
    }

    function applyFilters(){
      const qv = (q.value || '').trim().toLowerCase();
      let filtered = products.slice();

      if (activeType) {
        filtered = filtered.filter(it => it.type === activeType);
      }

      if (qv) {
        filtered = filtered.filter(it => (
          ((it.title||'') + ' ' + (it.description||'') + ' ' + (it.tags||[]).join(' '))
            .toLowerCase()
            .includes(qv)
        ));
      }

      if (sort.value === 'alpha') {
        filtered.sort((a,b)=>a.title.localeCompare(b.title));
      } else if (sort.value === 'alpha-desc') {
        filtered.sort((a,b)=>b.title.localeCompare(a.title));
      } else if (sort.value === 'price-asc') {
        filtered.sort((a,b)=> getPriceValue(a) - getPriceValue(b));
      } else if (sort.value === 'price-desc') {
        filtered.sort((a,b)=> getPriceValue(b) - getPriceValue(a));
      }

      renderList(filtered);
    }

    // 3D Viewer System
    function attach3DHandlers(){
      document.querySelectorAll('.view-3d').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const file = e.currentTarget.getAttribute('data-file');
          const p = products.find(x => String(x.id) === String(id));
          if (!p || !file) return;
          
          open3DViewer(p, file);
        });
      });
    }

    function open3DViewer(product, modelFile){
      const modal = document.createElement('div');
      modal.id = 'viewer-modal';
      modal.innerHTML = `
        <div id="viewer-modal-inner">
          <div id="viewer-modal-header">
            <h2>${escapeHtml(product.title)}</h2>
            <button class="btn ghost" id="close-viewer">Close</button>
          </div>
          <div id="viewer-canvas-container">
            <canvas id="viewer-canvas"></canvas>
            <div class="viewer-loading" id="viewer-loading">Loading 3D model...</div>
            <div class="viewer-controls" id="viewer-controls" style="display:none;">
              <button id="reset-view">Reset View</button>
              <button id="zoom-in">Zoom In</button>
              <button id="zoom-out">Zoom Out</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      document.getElementById('close-viewer').addEventListener('click', ()=>{
        cleanup3DViewer();
        modal.remove();
      });
      
      modal.addEventListener('click', (e)=>{
        if(e.target === modal){
          cleanup3DViewer();
          modal.remove();
        }
      });

      init3DViewer(modelFile);
    }

    function init3DViewer(modelFile){
      const container = document.getElementById('viewer-canvas-container');
      const canvas = document.getElementById('viewer-canvas');
      const loading = document.getElementById('viewer-loading');
      const controls = document.getElementById('viewer-controls');
      
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a1628);
      
      const camera = new THREE.PerspectiveCamera(
        50,
        container.clientWidth / container.clientHeight,
        0.1,
        1000
      );
      camera.position.set(0, 0, 5);
      
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      
      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight1.position.set(5, 5, 5);
      scene.add(directionalLight1);
      
      const directionalLight2 = new THREE.DirectionalLight(0x4fc3f7, 0.4);
      directionalLight2.position.set(-5, -5, -5);
      scene.add(directionalLight2);
      
      // Grid helper
      const gridHelper = new THREE.GridHelper(10, 10, 0x4fc3f7, 0x2196f3);
      gridHelper.material.opacity = 0.2;
      gridHelper.material.transparent = true;
      scene.add(gridHelper);
      
      let model = null;
      let isDragging = false;
      let previousMousePosition = { x: 0, y: 0 };
      
      // Load model (simplified - would need STLLoader for real implementation)
      // For demo, create a placeholder geometry
      const geometry = new THREE.BoxGeometry(1, 1, 1);
      const material = new THREE.MeshPhongMaterial({ 
        color: 0x4fc3f7,
        shininess: 80,
        specular: 0x64b5f6
      });
      model = new THREE.Mesh(geometry, material);
      scene.add(model);
      
      loading.textContent = 'Model loaded! Drag to rotate, scroll to zoom';
      setTimeout(()=>{
        loading.style.display = 'none';
        controls.style.display = 'flex';
      }, 1000);
      
      // Mouse controls
      canvas.addEventListener('mousedown', (e)=>{
        isDragging = true;
        previousMousePosition = { x: e.clientX, y: e.clientY };
      });
      
      canvas.addEventListener('mousemove', (e)=>{
        if(!isDragging || !model) return;
        
        const deltaX = e.clientX - previousMousePosition.x;
        const deltaY = e.clientY - previousMousePosition.y;
        
        model.rotation.y += deltaX * 0.01;
        model.rotation.x += deltaY * 0.01;
        
        previousMousePosition = { x: e.clientX, y: e.clientY };
      });
      
      canvas.addEventListener('mouseup', ()=>{ isDragging = false; });
      canvas.addEventListener('mouseleave', ()=>{ isDragging = false; });
      
      // Touch controls
      let touchStartX = 0, touchStartY = 0;
      canvas.addEventListener('touchstart', (e)=>{
        const touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
      });
      
      canvas.addEventListener('touchmove', (e)=>{
        if(!model || e.touches.length !== 1) return;
        e.preventDefault();
        
        const touch = e.touches[0];
        const deltaX = touch.clientX - touchStartX;
        const deltaY = touch.clientY - touchStartY;
        
        model.rotation.y += deltaX * 0.01;
        model.rotation.x += deltaY * 0.01;
        
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
      }, { passive: false });
      
      // Zoom
      canvas.addEventListener('wheel', (e)=>{
        e.preventDefault();
        camera.position.z += e.deltaY * 0.01;
        camera.position.z = Math.max(2, Math.min(15, camera.position.z));
      }, { passive: false });
      
      // Control buttons
      document.getElementById('reset-view').addEventListener('click', ()=>{
        if(model){
          model.rotation.set(0, 0, 0);
          camera.position.set(0, 0, 5);
        }
      });
      
      document.getElementById('zoom-in').addEventListener('click', ()=>{
        camera.position.z = Math.max(2, camera.position.z - 0.5);
      });
      
      document.getElementById('zoom-out').addEventListener('click', ()=>{
        camera.position.z = Math.min(15, camera.position.z + 0.5);
      });
      
      // Animation loop
      function animate(){
        if(!document.getElementById('viewer-modal')) return;
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();
      
      // Handle resize
      function onResize(){
        if(!document.getElementById('viewer-modal')) return;
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      }
      window.addEventListener('resize', onResize);
      
      viewer3D = { scene, camera, renderer, model, onResize };
    }

    function cleanup3DViewer(){
      if(viewer3D){
        window.removeEventListener('resize', viewer3D.onResize);
        if(viewer3D.renderer){
          viewer3D.renderer.dispose();
        }
        if(viewer3D.model && viewer3D.model.geometry){
          viewer3D.model.geometry.dispose();
        }
        if(viewer3D.model && viewer3D.model.material){
          viewer3D.model.material.dispose();
        }
        viewer3D = null;
      }
    }

    async function loadAll(){
      try {
        const raw = await fetchProducts();
        products = raw;
        const types = gatherTypes(products);
        buildChips(types);
        applyFilters();
      } catch (err){
        grid.innerHTML = `<div style="color:var(--muted); padding:24px; text-align:center;">Failed to load products. Make sure products.json exists in /products folder.<br><small style="display:block;margin-top:12px;">${escapeHtml(String(err))}</small></div>`;
        empty.style.display='none';
        console.error(err);
      }
    }

    if(sortBtn){
      sortBtn.addEventListener('click', ()=> sortOpts.classList.toggle('hidden'));
      document.querySelectorAll('.custom-select-option').forEach(o=>{
        o.addEventListener('click', ()=>{
          sort.value = o.getAttribute('data-value');
          sortBtn.textContent = o.textContent + ' ‚ñæ';
          sortOpts.classList.add('hidden');
          applyFilters();
        });
      });
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#sort-dropdown')) {
          sortOpts.classList.add('hidden');
        }
      });
    }

    let debounce;
    q.addEventListener('input', ()=>{ 
      clearTimeout(debounce); 
      debounce = setTimeout(applyFilters, 200);
    });
    sort.addEventListener('change', applyFilters);

    loadAll();
  })();
  </script>
</body>
</html>
